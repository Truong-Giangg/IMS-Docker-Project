#!KAMAILIO
# P-CSCF configuration
debug=2
log_stderror=no
children=4

listen=udp:0.0.0.0:4060
listen=tcp:0.0.0.0:4060
alias=pcscf.localdomain

loadmodule "sl.so"
loadmodule "tm.so"
loadmodule "rr.so"
loadmodule "pv.so"
loadmodule "xlog.so"
loadmodule "textops.so"
loadmodule "path.so"
loadmodule "topoh.so"

modparam("path", "use_received", 1)
modparam("topoh", "mask_key", "pcscf-secret")
modparam("topoh", "mask_ip", "127.0.0.1")

request_route {
    force_rport();
    remove_hf("Route");

    # REGISTER handling
    if (is_method("REGISTER")) {
        add_path();
        $du = "sip:127.0.0.1:5060";  # Forward to I-CSCF
        t_relay(); exit;
    }

    # In-dialog request (safe check)
    if ($(hdr(To){param.value,tag}) != $null) {
        route(RELAY); exit;
    }

    # Initial requests -> I-CSCF
    $du = "sip:127.0.0.1:5060";
    t_relay(); exit;
}

route[RELAY] {
    if (!t_relay()) sl_reply_error();
}
